<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel - Ahsan Labs</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          animation: { 'pulse-slow': 'pulse 6s ease-in-out infinite' }
        }
      }
    }
  </script>
  <style>
    :root {
      --gradient-from: #f8fafc;
      --gradient-via: #e0e7ff;
      --gradient-to: #ffffff;
    }
    .dark {
      --gradient-from: #0f172a;
      --gradient-via: #1e293b;
      --gradient-to: #1e293b;
    }
    body {
      background: linear-gradient(to bottom, var(--gradient-from), var(--gradient-via), var(--gradient-to));
      min-height: 100vh;
      transition: background 0.5s ease;
    }
    .glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .dark .glass {
      background: rgba(30, 41, 59, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .blob {
      position: absolute;
      border-radius: 50%;
      filter: blur(60px);
      opacity: 0.15;
      animation: float 20s infinite ease-in-out;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-30px) rotate(10deg); }
    }
    .toast {
      animation: slideIn 0.4s ease-out, slideOut 0.4s ease-in 2.6s forwards;
    }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
  </style>
</head>
<body class="text-slate-800 dark:text-slate-100 font-sans">

  <!-- Animated Gradient Blobs -->
  <div class="fixed inset-0 pointer-events-none overflow-hidden">
    <div class="blob w-96 h-96 bg-indigo-400 top-20 left-20 animate-pulse-slow"></div>
    <div class="blob w-80 h-80 bg-purple-400 bottom-20 right-20 animate-pulse-slow delay-1000"></div>
    <div class="blob w-72 h-72 bg-pink-400 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 animate-pulse-slow delay-500"></div>
  </div>

  <div class="relative z-10 container max-w-7xl mx-auto p-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
      <div>
        <h1 class="text-4xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600">
          Admin Panel
        </h1>
        <p class="text-slate-600 dark:text-slate-400">Manage your digital products</p>
      </div>
      <div class="flex items-center gap-4">
        <button id="uploadImagesBtn" class="btn glass px-5 py-2.5 rounded-xl font-medium shadow-lg hover:scale-105 transition-all">
          Upload Images
        </button>
        <button id="themeToggle" class="p-2 rounded-xl glass shadow-lg hover:scale-110 transition-all">
          Moon Icon
        </button>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-4 mb-8">
      <button id="addNewBtn" class="btn bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition-all flex items-center gap-2">
        Add New Product
      </button>
      <button id="resetBtn" class="btn bg-gradient-to-r from-red-500 to-pink-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition-all">
        Reset All
      </button>
    </div>

    <!-- Products Table -->
    <div class="glass rounded-3xl overflow-hidden shadow-2xl">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-slate-800/50 dark:bg-slate-900/70">
            <tr>
              <th class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">ID</th>
              <th class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">Name</th>
              <th class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">Price</th>
              <th class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">Category</th>
              <th class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">Stock</th>
              <th class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody id="productsTable" class="divide-y divide-slate-700/50"></tbody>
        </table>
      </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 hidden flex items-center justify-center p-4 z-50">
      <div class="glass rounded-3xl p-8 max-w-4xl w-full max-h-[85vh] overflow-y-auto shadow-2xl">
        <h2 class="text-2xl font-bold mb-6 bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600">
          Edit Product
        </h2>
        <div id="editForm" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        <div class="flex gap-4 mt-8">
          <button id="saveEditBtn" class="flex-1 bg-gradient-to-r from-emerald-500 to-teal-500 text-white py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition-all">
            Save Changes
          </button>
          <button id="cancelEditBtn" class="flex-1 bg-gradient-to-r from-slate-600 to-slate-700 text-white py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition-all">
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="fixed inset-0 hidden flex items-center justify-center p-4 z-50">
      <div class="glass rounded-3xl p-8 max-w-2xl w-full shadow-2xl">
        <h2 class="text-2xl font-bold mb-6 bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600">
          Upload Images
        </h2>
        <div class="space-y-6">
          <div>
            <label class="block text-sm font-medium mb-2">Select Images</label>
            <input type="file" id="bulkImageInput" accept="image/*" multiple class="w-full p-3 rounded-xl bg-white/10 border border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Prefix (optional)</label>
            <input type="text" id="bulkCustomPrefix" placeholder="e.g., product_" class="w-full p-3 rounded-xl bg-white/10 border border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none">
          </div>
          <div id="bulkUploadStatus" class="text-sm font-medium"></div>
          <div id="uploadedImagesList" class="max-h-48 overflow-y-auto space-y-2"></div>
        </div>
        <div class="flex gap-4 mt-8">
          <button id="bulkUploadBtn" class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition-all">
            Upload All
          </button>
          <button id="closeUploadModal" class="flex-1 bg-gradient-to-r from-slate-600 to-slate-700 text-white py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition-all">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="fixed bottom-6 right-6 space-y-3 z-50"></div>

  <script>
    const API_URL = 'http://localhost:5000/api/products';
    let products = [];
    let editingId = null;
    let editedProduct = null;

    // Theme Toggle
    const themeToggle = document.getElementById('themeToggle');
    const html = document.documentElement;
    const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`;
    const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`;

    if (localStorage.getItem('darkMode') === 'true' || (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      html.classList.add('dark');
      themeToggle.innerHTML = sunIcon;
    } else {
      themeToggle.innerHTML = moonIcon;
    }

    themeToggle.addEventListener('click', () => {
      html.classList.toggle('dark');
      const isDark = html.classList.contains('dark');
      themeToggle.innerHTML = isDark ? sunIcon : moonIcon;
      localStorage.setItem('darkMode', isDark);
    });

    // Load products
    async function loadProducts() {
      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error('Failed to load');
        products = await res.json();
        renderTable();
      } catch (err) {
        showToast('Failed to load products', 'error');
      }
    }

    // Render table
    function renderTable() {
      const tbody = document.getElementById('productsTable');
      tbody.innerHTML = '';
      products.forEach(p => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-white/5 dark:hover:bg-slate-800/50 transition-all';
        tr.innerHTML = `
          <td class="px-6 py-4 text-sm">${p.id}</td>
          <td class="px-6 py-4 font-medium">${p.name}</td>
          <td class="px-6 py-4">PKR ${p.price.toFixed(2)}</td>
          <td class="px-6 py-4"><span class="px-3 py-1 rounded-full text-xs font-medium bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400">${p.category}</span></td>
          <td class="px-6 py-4"><span class="text-sm ${p.inStock ? 'text-emerald-500' : 'text-red-500'}">${p.inStock ? 'Yes' : 'No'}</span></td>
          <td class="px-6 py-4">
            <div class="flex gap-2">
              <button onclick="editProduct('${p.id}')" class="px-3 py-1.5 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-lg text-xs font-medium hover:scale-105 transition-all">Edit</button>
              <button onclick="deleteProduct('${p.id}')" class="px-3 py-1.5 bg-gradient-to-r from-red-500 to-pink-500 text-white rounded-lg text-xs font-medium hover:scale-105 transition-all">Delete</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Toast
    function showToast(msg, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast px-6 py-3 rounded-xl shadow-2xl text-white font-medium ${type === 'error' ? 'bg-gradient-to-r from-red-500 to-pink-500' : 'bg-gradient-to-r from-emerald-500 to-teal-500'}`;
      toast.textContent = msg;
      document.getElementById('toastContainer').appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Edit
    function editProduct(id) {
      const p = products.find(x => x.id === id) || { id: Date.now().toString(), features: [] };
      editingId = p.id;
      editedProduct = { ...p, features: p.features || [] };
      showEditModal();
    }

    function showEditModal() {
      const form = document.getElementById('editForm');
      form.innerHTML = `
        ${['name', 'description', 'price', 'originalPrice', 'category', 'image', 'rating', 'reviews', 'offerEndsAt', 'whatsappNumber', 'whatsappMessage', 'productlink', 'specialcode', 'specialdisc', 'scratch_coupon'].map(field => `
          <div>
            <label class="block text-sm font-medium mb-1 capitalize">${field.replace(/([A-Z])/g, ' $1')}</label>
            ${field === 'description' ? `<textarea class="w-full p-3 rounded-xl bg-white/10 border border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none" data-field="${field}" rows="3">${editedProduct[field] || ''}</textarea>` :
             field === 'features' ? `<textarea class="w-full p-3 rounded-xl bg-white/10 border border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none" data-field="features" rows="2">${editedProduct.features.join(', ')}</textarea>` :
             field === 'is_scratch' ? `<label class="flex items-center gap-2"><input type="checkbox" data-field="is_scratch" ${editedProduct.is_scratch ? 'checked' : ''}> <span class="text-sm">Enable Scratch Card</span></label>` :
             field === 'image' ? `
               <input type="text" value="${editedProduct.image || ''}" class="w-full p-3 rounded-xl bg-white/10 border border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none mb-2" data-field="image" placeholder="/images/product.jpg">
               <div class="flex gap-2 items-center">
                 <input type="file" id="productImageInput" accept="image/*" class="flex-1">
                 <input type="text" id="customImageName" placeholder="filename" class="w-32 p-2 rounded bg-white/10 border">
                 <button onclick="uploadProductImage()" class="px-3 py-1 bg-indigo-600 text-white rounded text-xs">Upload</button>
               </div>
               <div id="imageUploadStatus" class="text-xs mt-1"></div>
               ${editedProduct.image ? `<img src="http://localhost:5000${editedProduct.image}" class="mt-2 h-20 w-20 object-cover rounded-lg border">` : ''}
             ` :
             ['price', 'originalPrice', 'rating', 'reviews', 'specialdisc', 'scratch_disc'].includes(field) ?
               `<input type="number" step="${field.includes('price') ? '0.01' : field === 'rating' ? '0.1' : '1'}" value="${editedProduct[field] || 0}" class="w-full p-3 rounded-xl bg-white/10 border border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none" data-field="${field}">` :
             field === 'offerEndsAt' ?
               `<input type="datetime-local" value="${editedProduct.offerEndsAt ? new Date(editedProduct.offerEndsAt).toISOString().slice(0,16) : ''}" class="w-full p-3 rounded-xl bg-white/10 border border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none" data-field="${field}">` :
               `<input type="text" value="${editedProduct[field] || ''}" class="w-full p-3 rounded-xl bg-white/10 border border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none" data-field="${field}">`}
          </div>
        `).join('')}
        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-1">Features (comma-separated)</label>
          <textarea class="w-full p-3 rounded-xl bg-white/10 border border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none" data-field="features" rows="2">${editedProduct.features.join(', ')}</textarea>
        </div>
      `;
      document.getElementById('editModal').classList.remove('hidden');
    }

    // Save
    async function saveEdit() {
      if (!validateForm()) return showToast('Fill all required fields', 'error');

      const inputs = document.querySelectorAll('#editForm [data-field]');
      inputs.forEach(inp => {
        const f = inp.dataset.field;
        if (inp.type === 'checkbox') editedProduct[f] = inp.checked;
        else if (inp.type === 'number') editedProduct[f] = parseFloat(inp.value) || 0;
        else if (f === 'features') editedProduct[f] = inp.value.split(',').map(s => s.trim()).filter(Boolean);
        else editedProduct[f] = inp.value.trim();
      });

      const idx = products.findIndex(p => p.id === editingId);
      if (idx > -1) products[idx] = editedProduct;
      else products.push(editedProduct);

      await saveProducts(products);
      closeModal('editModal');
      renderTable();
      showToast('Product saved!');
    }

    function validateForm() {
      return ['name', 'price', 'category'].every(f => {
        const el = document.querySelector(`[data-field="${f}"]`);
        const valid = el.value.trim();
        el.classList.toggle('border-red-500', !valid);
        return valid;
      });
    }

    function closeModal(id) {
      document.getElementById(id).classList.add('hidden');
    }

    async function deleteProduct(id) {
      if (!confirm('Delete this product?')) return;
      products = products.filter(p => p.id !== id);
      await saveProducts(products);
      renderTable();
      showToast('Product deleted');
    }

    function addNewProduct() {
      editProduct(null);
    }

    async function resetToDefault() {
      if (!confirm('Reset all products?')) return;
      await saveProducts([]);
      products = [];
      renderTable();
      showToast('Reset complete');
    }

    async function saveProducts(data) {
      await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    }

    async function uploadProductImage() {
      const file = document.getElementById('productImageInput').files[0];
      const name = document.getElementById('customImageName').value.trim();
      const status = document.getElementById('imageUploadStatus');
      if (!file) return;

      const fd = new FormData();
      fd.append('image', file);
      if (name) fd.append('customName', name);

      status.textContent = 'Uploading...';
      try {
        const res = await fetch('http://localhost:5000/api/upload-image', { method: 'POST', body: fd });
        const data = await res.json();
        if (res.ok) {
          document.querySelector('[data-field="image"]').value = data.imageUrl;
          status.innerHTML = `<span class="text-green-400">Uploaded!</span>`;
          const img = form.querySelector('img') || document.createElement('img');
          img.src = `http://localhost:5000${data.imageUrl}`;
          img.className = 'mt-2 h-20 w-20 object-cover rounded-lg border';
          form.querySelector('[data-field="image"]').parentElement.appendChild(img);
        } else throw new Error(data.error);
      } catch (e) {
        status.innerHTML = `<span class="text-red-400">${e.message}</span>`;
      }
    }

    // Bulk Upload
    async function bulkUploadImages() {
      const files = document.getElementById('bulkImageInput').files;
      const prefix = document.getElementById('bulkCustomPrefix').value.trim();
      const status = document.getElementById('bulkUploadStatus');
      const list = document.getElementById('uploadedImagesList');
      if (!files.length) return;

      list.innerHTML = ''; status.textContent = `Uploading ${files.length}...`;
      let ok = 0, fail = 0;

      for (let i = 0; i < files.length; i++) {
        const fd = new FormData();
        fd.append('image', files[i]);
        if (prefix) fd.append('customName', `${prefix}${i+1}`);
        try {
          const res = await fetch('http://localhost:5000/api/upload-image', { method: 'POST', body: fd });
          const data = await res.json();
          const div = document.createElement('div');
          div.className = `p-2 rounded-lg text-sm ${res.ok ? 'bg-emerald-900/50 text-emerald-300' : 'bg-red-900/50 text-red-300'}`;
          div.innerHTML = res.ok ? `Success: ${data.imageUrl}` : `Failed: ${files[i].name}`;
          list.appendChild(div);
          res.ok ? ok++ : fail++;
        } catch { fail++; }
      }
      status.textContent = `Done: ${ok} success, ${fail} failed`;
      status.className = fail ? 'text-yellow-400' : 'text-emerald-400';
    }

    // Events
    document.getElementById('addNewBtn').onclick = addNewProduct;
    document.getElementById('resetBtn').onclick = resetToDefault;
    document.getElementById('saveEditBtn').onclick = saveEdit;
    document.getElementById('cancelEditBtn').onclick = () => closeModal('editModal');
    document.getElementById('uploadImagesBtn').onclick = () => document.getElementById('uploadModal').classList.remove('hidden');
    document.getElementById('closeUploadModal').onclick = () => closeModal('uploadModal');
    document.getElementById('bulkUploadBtn').onclick = bulkUploadImages;

    loadProducts();
  </script>
</body>
</html>